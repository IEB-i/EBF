<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Participantes</title>
    <link rel="shortcut icon" href="../assets/3.ico" type="image/x-icon">
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap4.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            color: #333;
            padding-top: 80px;
        }

        .filter-card {
            background-color: #f8f9fa;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 15px;
            margin-bottom: 20px;
        }

        .btn-export {
            background: linear-gradient(45deg, #3d7517, #3d7517);
            color: white;
            border: none;
        }

        .table-responsive {
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            max-height: 400px;
            overflow-y: auto;
            overflow-x: auto;
        }

        .badge-pago {
            background-color: #28a745;
        }

        .badge-pendente {
            background-color: #ffc107;
        }

        .btn-voltar {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .btn-voltar:hover {
            background-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transform: translateY(-50%) scale(1.05);
            color: white;
            text-decoration: none;
        }

        .btn-voltar .material-icons {
            font-size: 24px;
        }

        /* Fixar o cabe√ßalho da tabela */
        .dataTables_wrapper .dataTables_scroll div.dataTables_scrollHead {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #fff;
        }

        /* Ajustar a √°rea de rolagem para mostrar apenas o corpo da tabela */
        .dataTables_wrapper .dataTables_scroll {
            max-height: 400px;
            /* Ajuste conforme necess√°rio */
        }

        .dataTables_wrapper .dataTables_scrollBody {
            max-height: 350px;
            /* Altura m√°xima para o corpo da tabela */
            overflow-y: auto;
        }

        /* Garantir que os controles de pesquisa fiquem fora da √°rea de rolagem */
        .dataTables_wrapper .dataTables_filter,
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_paginate {
            position: relative;
            z-index: 20;
            background-color: #fff;
            padding: 5px 0;
        }

        /* Ajustar o espa√ßamento entre os controles e a tabela */
        .dataTables_wrapper .dataTables_filter {
            margin-bottom: 10px;
        }

        /* Garantir que o t√≠tulo da tabela fique fixo */
        .container h3 {
            position: sticky;
            top: 0;
            background-color: #fff;
            z-index: 30;
            padding: 10px 0;
            margin-bottom: 15px;
        }


        .table-responsive {
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            /* Espa√ßo adicional na parte inferior */
        }

        /* Garante que o cabe√ßalho e o corpo da tabela tenham a mesma largura */
        #participantesTable thead th,
        #participantesTable tbody td {
            white-space: nowrap;
            min-width: 100px;
        }

        /* Melhora a apar√™ncia da tabela com rolagem */
        #participantesTable {
            width: 100% !important;
            margin-bottom: 0;
        }

        .table-container {
            position: relative;
            margin-bottom: 30px;
        }

        .table-responsive {
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            /* Importante para manter os cantos arredondados */
        }

        .chart-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            padding: 15px;
            backdrop-filter: blur(10px);
        }

        .chart-title {
            text-align: center;
            margin-bottom: 25px;
            color: #2c3e50;
            font-weight: 700;
            font-size: 1.4rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>
    <!-- CABE√áALHO -->
    <div class="header">
        <a href="gestao.html" class="btn-voltar">
            <i class="material-icons">arrow_back</i>
        </a>
        <h2 class="header-title">CRIAN√áAS INSCRITAS</h2>
    </div>

    <!-- CONTE√öDO PRINCIPAL -->
    <div class="container mt-5">
        <!-- Cabe√ßalho T√≠tulo + Download Excel -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h3>Lista das Crian√ßas Inscritas</h3>
            </div>
            <div class="col-md-4 text-right">
                <button class="btn btn-export mr-2">
                    <i class="material-icons align-middle">file_download</i> Exportar Excel
                </button>
            </div>
        </div>

        <!-- Gr√°fico de Faixas Et√°rias -->
        <div class="chart-card">
            <h4 class="chart-title">üìä Distribui√ß√£o por Faixa Et√°ria</h4>
            <div class="chart-container">
                <canvas id="faixaEtariaChart"></canvas>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filter-card">
            <form id="filterForm" class="row">
                <!-- Filtro Status de Pagamento -->
                <div class="form-group col-md-3">
                    <label for="filterPagamento">Status Pagamento</label>
                    <select class="form-control" id="filterPagamento">
                        <option value="">Todos</option>
                        <option value="pago">Pago</option>
                        <option value="pendente">Pendente</option>
                    </select>
                </div>
                <!-- Bot√µes -->
                <div class="form-group col-md-3 d-flex align-items-end">
                    <!-- Filtrar -->
                    <button type="submit" class="btn btn-primary">
                        <i class="material-icons align-middle">search</i> Filtrar
                    </button>
                    <!-- Limpar -->
                    <button type="button" class="btn btn-outline-secondary ml-2" id="limparFiltro">
                        Limpar
                    </button>
                </div>
            </form>
        </div>

        <div class="table-container">
            <div class="table-responsive">
                <table class="table table-striped" id="participantesTable">
                    <thead class="thead-dark">
                        <tr>
                            <th>Nome</th>
                            <th>Idade</th>
                            <th>Respons√°vel</th>
                            <th>Cel. Respons√°vel</th>
                            <th>Igreja</th>
                            <th>Pagamento</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="participantesList">
                        <!-- Os dados ser√£o carregados dinamicamente do Firebase -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Rodap√© -->
        <div class="row mt-3 mb-4">
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-body py-2">
                        <strong>Total de participantes:</strong> <span id="contador-participantes">0</span>
                        <span id="texto-filtro" class="ml-2 text-muted font-italic" style="display: none;">(filtrados de
                            <span id="total-participantes">0</span>)</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Detalhes-->
        <div class="modal fade" id="participanteModal" tabindex="-1" role="dialog"
            aria-labelledby="participanteModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <!-- Cabe√ßalho -->
                    <div class="modal-header">
                        <h5 class="modal-title" id="participanteModalLabel">Dados da Crian√ßa</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <!-- Dados -->
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Informa√ß√µes Pessoais</h6>
                                <hr>
                                <p><strong>Nome:</strong> <span id="modalNome"></span></p>
                                <p><strong>Data de Nascimento:</strong> <span id="modalDtNasc"></span></p>
                                <p><strong>Idade:</strong> <span id="modalIdade"></span></p>
                                <p><strong>Alergia:</strong> <span id="modalAlergia"></span></p>
                                <p><strong>Quais Alergias:</strong> <span id="modalquaisAlergias"></span></p>
                            </div>
                            <div class="col-md-6">
                                <h6>Informa√ß√µes do Respons√°vel</h6>
                                <hr>
                                <p><strong>Nome do Respons√°vel 1:</strong> <span id="modalResponsavel"></span></p>
                                <p><strong>Nome do Respons√°vel 2:</strong> <span id="modalResponsavel2"></span></p>
                                <p><strong>Celular do Respons√°vel:</strong> <span id="modalCelularResp"></span></p>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6>Informa√ß√µes Igreja</h6>
                                <hr>
                                <p><strong>Igreja:</strong> <span id="modalIgreja"></span></p>
                                <p><strong>Outra Igreja:</strong> <span id="modalOutraIgreja"></span></p>
                                <p><strong>Endere√ßo:</strong> <span id="modalEndereco"></span></p>
                                <p><strong>Bairro:</strong> <span id="modalBairro"></span></p>
                                <p><strong>Cidade:</strong> <span id="modalCidade"></span></p>
                            </div>
                            <div class="col-md-6">
                                <h6>Informa√ß√µes Pagamento</h6>
                                <hr>
                                <p><strong>Status:</strong> <span id="modalStatusPagamento"></span></p>
                                <p><strong>Data de Preenchimento:</strong> <span id="modalDataPreenchimento"></span></p>
                                <p><strong>Data de Registro:</strong> <span id="modalDtRegistro"></span></p>
                                <p><strong>Ano do Evento:</strong> <span id="modalAnoEvento"></span></p>
                            </div>
                        </div>
                    </div>
                    <!-- Bot√µes -->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger mr-auto" id="btnExcluirParticipante">
                            <i class="material-icons align-middle">delete</i> Excluir Participante
                        </button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="../firebase/firebaseConfig.js"></script>

    <script>

        // Inicializa√ß√£o do DataTable
        let dataTable;
        let totalParticipantes = 0;
        let faixaEtariaChart;

        //Modal e gest√£o do doc
        $(document).ready(function () {
            // Carregar participantes do Firebase
            carregarParticipantes();

            // Inicializar DataTable
            dataTable = $('#participantesTable').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/pt-BR.json'
                },
                responsive: true,
                dom: 'Bfrti', // Removido 'p' (pagina√ß√£o)
                paging: false, // Desativa a pagina√ß√£o
                scrollY: '350px', // Altura fixa para a √°rea de rolagem
                scrollCollapse: true, // Mant√©m o colapso da altura
                fixedHeader: true, // Mant√©m o cabe√ßalho fixo durante a rolagem
                buttons: [
                    {
                        extend: 'excel',
                        text: 'Exportar Excel',
                        className: 'btn btn-export d-none',
                        exportOptions: {
                            columns: [0, 1, 2, 3, 4, 5, 6]
                        }
                    },
                ]
            });

            // Associar bot√µes personalizados aos bot√µes do DataTable
            $('.btn-export').eq(0).on('click', function () {
                dataTable.button(0).trigger();
            });

            $('.btn-export').eq(1).on('click', function () {
                dataTable.button(1).trigger();
            });

            // Filtrar participantes
            $('#filterForm').on('submit', function (e) {
                e.preventDefault();
                aplicarFiltros();
            });

            // Limpar filtros
            $('#limparFiltro').on('click', function () {
                $('#filterForm')[0].reset();
                aplicarFiltros();
            });

            // Controlar a visibilidade do campo de forma de pagamento
            $('#updatePagamento').on('change', function () {
                if ($(this).val() === 'pago') {
                    $('#divFormaPagamento').show();
                    $('#updateFormaPagamento').prop('required', true);
                } else {
                    $('#divFormaPagamento').hide();
                    $('#updateFormaPagamento').prop('required', false);
                }
            });

            // Atualizar status de pagamento
            $('#btnSalvarPagamento').on('click', function () {
                const participanteId = $(this).data('id');
                const novoStatus = $('#updatePagamento').val();

                // Verificar se a forma de pagamento foi preenchida quando o status √© pago
                if (novoStatus === 'pago' && !$('#updateFormaPagamento').val()) {
                    $('#updateFormaPagamento').addClass('is-invalid');
                    return; // Interrompe a execu√ß√£o se o campo estiver vazio
                }

                const dadosAtualizacao = {
                    statusPagamento: novoStatus,
                    dataPagamento: novoStatus === 'pago' ? new Date().toISOString() : null
                };

                // Adiciona a forma de pagamento apenas se status for pago
                if (novoStatus === 'pago') {
                    dadosAtualizacao.formaPagamento = $('#updateFormaPagamento').val();
                } else {
                    dadosAtualizacao.formaPagamento = ''; // Limpa a forma de pagamento se status for pendente
                }

                db.collection("Eventos").doc("EBF2025").collection("inscricoes").doc(participanteId)
                    .update(dadosAtualizacao)
                    .then(() => {
                        alert('Status de pagamento atualizado com sucesso!');
                        $('#participanteModal').modal('hide');
                        carregarParticipantes();
                    })
                    .catch((error) => {
                        console.error("Erro ao atualizar pagamento: ", error);
                        alert("Erro ao atualizar pagamento. Tente novamente.");
                    });
            });

            // Adicione este c√≥digo ao seu script existente
            $('#participanteModal').on('hide.bs.modal', function (e) {
                // Remover o foco de todos os elementos foc√°veis dentro do modal
                $(this).find('button, input, select, textarea, a[href]').blur();
            });

            // Configurar o bot√£o de exclus√£o
            $('#btnExcluirParticipante').on('click', function () {
                const participanteId = $(this).data('id');

                if (!participanteId) {
                    // Tentar recuperar do outro bot√£o como fallback
                    const fallbackId = $('#btnSalvarPagamento').data('id');

                    if (fallbackId) {
                        excluirParticipante(fallbackId);
                    } else {
                        alert("Erro: N√£o foi poss√≠vel identificar o participante para exclus√£o.");
                    }
                } else {
                    excluirParticipante(participanteId);
                }
            });
        });

        // Fun√ß√£o para Carregar participante
        function carregarParticipantes() {
            db.collection("Eventos").doc("EBF2025").collection("inscricoes")
                .where("anoevento", "==", "2025")
                .where("tipoInsc", "==", "criancas")
                .get()
                .then((querySnapshot) => {

                    // Limpar DataTable
                    dataTable.clear();

                    // Armazenar o total de participantes
                    totalParticipantes = querySnapshot.size;

                    // Array para armazenar dados dos participantes para o gr√°fico
                    const dadosParticipantes = [];

                    querySnapshot.forEach((doc) => {
                        const participante = doc.data();
                        
                        // Adicionar aos dados do gr√°fico
                        dadosParticipantes.push(participante);

                        // Linhas ao DataTable
                        dataTable.row.add([
                            participante.nome,
                            participante.idade,
                            participante.responsavel1,
                            participante.foneResponsavel,
                            participante.igreja === 'Outra' ? participante.outraIgreja : participante.igreja,
                            `<span class="badge ${participante.statusPagamento === 'pago' ? 'badge-pago' : 'badge-pendente'}">${participante.statusPagamento === 'pago' ? 'Pago' : 'Pendente'}</span>`,
                            `<button class="btn btn-info btn-sm" onclick="verDetalhes('${doc.id}')">Ver</button>`
                        ]);

                    });

                    // Renderizar DataTable
                    dataTable.draw();

                    // Criar gr√°fico de faixa et√°ria
                    criarGraficoFaixaEtaria(dadosParticipantes);

                    // Atualizar contador
                    atualizarContador();

                })
                .catch((error) => {
                    console.error("Erro ao carregar participantes: ", error);
                    alert("Erro ao carregar lista de participantes. Tente novamente.");
                });
        }

        // Adicione esta fun√ß√£o para atualizar o contador
        function atualizarContador() {
            const participantesFiltrados = dataTable.rows({ search: 'applied' }).count();

            $('#contador-participantes').text(participantesFiltrados);
            $('#total-participantes').text(totalParticipantes);

            // Mostrar ou esconder o texto de filtro
            if (participantesFiltrados < totalParticipantes) {
                $('#texto-filtro').show();
            } else {
                $('#texto-filtro').hide();
            }
        }

        function verDetalhes(participanteId) {
            db.collection("Eventos").doc("EBF2025").collection("inscricoes").doc(participanteId)
                .get()
                .then((doc) => {
                    if (doc.exists) {
                        const p = doc.data();

                        // Informa√ß√µes Pessoais
                        $('#modalNome').text(p.nome || 'N/A');
                        $('#modalDtNasc').text(formatarData(p.dtnasc) || 'N/A');
                        $('#modalIdade').text(p.idade || 'N/A');
                        $('#modalAlergia').text(p.alergia || 'N/A');
                        $('#modalquaisAlergias').text(p.quaisAlergias || 'N/A');

                        // Informa√ß√µes do Respons√°vel
                        $('#modalResponsavel').text(p.responsavel1 || 'N/A');
                        $('#modalResponsavel2').text(p.responsavel2 || 'N/A');
                        $('#modalCelularResp').text(p.foneResponsavel || 'N/A');

                        // Informa√ß√µes da Igreja
                        if (p.igreja === 'Outra') {
                            $('#modalIgreja').text(p.outraIgreja || 'Outra (n√£o especificada)');
                        } else {
                            $('#modalIgreja').text(p.igreja || 'N/A');
                        }
                        $('#modalEndereco').text(p.endereco || 'N/A');
                        $('#modalBairro').text(p.bairro || 'N/A');
                        $('#modalCidade').text(p.cidade || 'N/A');

                        // Informa√ß√µes de Pagamento e Registro
                        $('#modalStatusPagamento').html(`<span class="badge ${p.statusPagamento === 'pago' ? 'badge-pago' : 'badge-pendente'}">${p.statusPagamento === 'pago' ? 'Pago' : 'Pendente'}</span>`);
                        $('#modalDataPreenchimento').text(p.dataPreenchimento || 'N/A');
                        $('#modalDtRegistro').text(formatarDataHora(p.dtRegistro) || 'N/A');
                        $('#modalAnoEvento').text(p.anoevento || 'N/A');

                        // Armazenar ID do participante no bot√£o de exclus√£o
                        $('#btnExcluirParticipante').data('id', doc.id);

                        // Abrir modal
                        $('#participanteModal').modal('show');
                    } else {
                        console.error("Documento n√£o encontrado para ID:", participanteId);
                        alert("Participante n√£o encontrado!");
                    }
                })
                .catch((error) => {
                    console.error("Erro ao buscar detalhes: ", error);
                    alert("Erro ao buscar detalhes do participante.");
                });
        }

        // Fun√ß√£o para formatar data e hora
        function formatarDataHora(dataString) {
            if (!dataString) return '';

            try {
                const data = new Date(dataString);
                return data.toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return dataString;
            }
        }

        function aplicarFiltros() {
            const filtroPagamento = $('#filterPagamento').val();

            dataTable.search('').columns().search('').draw();

            if (filtroPagamento) {
                dataTable.column(5).search(
                    filtroPagamento === 'pago' ? 'Pago' : 'Pendente', true, false
                ).draw();
            }
        }

        function formatarData(dataString) {
            if (!dataString) return '';

            try {
                const data = new Date(dataString);
                return data.toLocaleDateString('pt-BR');
            } catch (e) {
                return dataString;
            }
        }

        function excluirParticipante(participanteId) {
            if (!participanteId) {
                alert("Erro: N√£o foi poss√≠vel identificar o participante para exclus√£o.");
                return;
            }

            if (confirm("Tem certeza que deseja excluir este participante? Esta a√ß√£o n√£o pode ser desfeita.")) {
                db.collection("Eventos").doc("EBF2025").collection("inscricoes").doc(participanteId)
                    .delete()
                    .then(() => {
                        alert("Participante exclu√≠do com sucesso!");
                        $('#participanteModal').modal('hide');
                        setTimeout(function () {
                            window.location.reload();
                        }, 500);
                    })
                    .catch((error) => {
                        alert("Erro ao excluir participante: " + error.message);
                    });
            }

            carregarParticipantes(); // Recarrega a lista ap√≥s exclus√£o

        }

        // Fun√ß√£o para criar gr√°fico de faixa et√°ria
        function criarGraficoFaixaEtaria(dados) {
            const ctx = document.getElementById('faixaEtariaChart').getContext('2d');
            
            // Destruir gr√°fico existente se houver
            if (faixaEtariaChart) {
                faixaEtariaChart.destroy();
            }
            
            // Definir faixas et√°rias baseadas no check-in
            const faixas = {
                '2-5 anos': 0,
                '6-7 anos': 0,
                '8-9 anos': 0,
                '10-12 anos': 0,
                'Sem Faixa': 0
            };
            
            const coresInfo = {
                '2-5 anos': { cor: '#4CAF50', nome: 'Verde', emoji: 'üü¢' },
                '6-7 anos': { cor: '#dfca0d', nome: 'Amarela', emoji: 'üü°' },
                '8-9 anos': { cor: '#FF9C33', nome: 'Laranja', emoji: 'üü†' },
                '10-12 anos': { cor: '#FF4C4C', nome: 'Vermelha', emoji: 'üî¥' },
                'Sem Faixa': { cor: '#9E9E9E', nome: 'Cinza', emoji: '‚ö´' }
            };

            // Contar crian√ßas por faixa
            dados.forEach(participante => {
                const idade = parseInt(participante.idade);
                if (idade >= 2 && idade <= 5) {
                    faixas['2-5 anos']++;
                } else if (idade >= 6 && idade <= 7) {
                    faixas['6-7 anos']++;
                } else if (idade >= 8 && idade <= 9) {
                    faixas['8-9 anos']++;
                } else if (idade >= 10 && idade <= 12) {
                    faixas['10-12 anos']++;
                } else {
                    faixas['Sem Faixa']++;
                }
            });
            
            faixaEtariaChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(faixas),
                    datasets: [{
                        label: 'Quantidade de Crian√ßas',
                        data: Object.values(faixas),
                        backgroundColor: [
                            'rgba(76, 175, 80, 0.85)',    // Verde
                            'rgba(255, 235, 59, 0.85)',   // Amarela
                            'rgba(255, 156, 51, 0.85)',   // Laranja
                            'rgba(255, 76, 76, 0.85)',    // Vermelha
                            'rgba(158, 158, 158, 0.85)'   // Cinza para Sem Faixa
                        ],
                        borderColor: [
                            'rgba(76, 175, 80, 1)',       // Verde
                            'rgba(255, 193, 7, 1)',       // Amarela mais escura
                            'rgba(255, 156, 51, 1)',      // Laranja
                            'rgba(255, 76, 76, 1)',       // Vermelha
                            'rgba(158, 158, 158, 1)'      // Cinza para Sem Faixa
                        ],
                        borderWidth: 3,
                        borderRadius: {
                            topLeft: 8,
                            topRight: 8,
                            bottomLeft: 4,
                            bottomRight: 4
                        },
                        borderSkipped: false,
                        hoverBackgroundColor: [
                            'rgba(76, 175, 80, 0.95)',
                            'rgba(255, 235, 59, 0.95)',
                            'rgba(255, 156, 51, 0.95)',
                            'rgba(255, 76, 76, 0.95)',
                            'rgba(158, 158, 158, 0.95)'  // Cinza para Sem Faixa
                        ],
                        hoverBorderWidth: 4,
                        shadowOffsetX: 3,
                        shadowOffsetY: 3,
                        shadowBlur: 10,
                        shadowColor: 'rgba(0, 0, 0, 0.2)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(44, 62, 80, 0.95)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#3498db',
                            borderWidth: 2,
                            cornerRadius: 8,
                            displayColors: false,
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            padding: 12,
                            callbacks: {
                                title: function(context) {
                                    const faixa = context[0].label;
                                    const info = coresInfo[faixa];
                                    if (faixa === 'Sem Faixa') {
                                        return `${info.emoji} ${info.nome}`;
                                    }
                                    return `${info.emoji} Sala ${info.nome}`;
                                },
                                label: function(context) {
                                    const valor = context.parsed.y;
                                    const total = Object.values(faixas).reduce((a, b) => a + b, 0);
                                    const percentual = total > 0 ? ((valor / total) * 100).toFixed(1) : 0;
                                    return `${valor} crian√ßa${valor !== 1 ? 's' : ''} (${percentual}%)`;
                                }
                            }
                        },
                        // Plugin personalizado para mostrar valores em cima das barras
                        datalabels: false
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                color: '#5a6c7d',
                                font: {
                                    size: 14,
                                    weight: '500'
                                },
                                padding: 8
                            },
                            grid: {
                                color: 'rgba(90, 108, 125, 0.1)',
                                lineWidth: 1,
                                drawBorder: false
                            },
                            border: {
                                display: false
                            }
                        },
                        x: {
                            ticks: {
                                color: '#5a6c7d',
                                font: {
                                    size: 15,
                                    weight: 'bold'
                                },
                                padding: 8,
                                maxRotation: 0
                            },
                            grid: {
                                display: false
                            },
                            border: {
                                display: false
                            }
                        }
                    },
                    animation: {
                        duration: 1500,
                        easing: 'easeInOutCubic',
                        delay: (context) => {
                            return context.dataIndex * 200;
                        },
                        onComplete: function() {
                            // Desenhar valores em cima das barras ap√≥s a anima√ß√£o
                            const chart = this;
                            const ctx = chart.ctx;
                            
                            ctx.font = 'bold 19px Montserrat';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'bottom';
                            
                            chart.data.datasets.forEach((dataset, i) => {
                                const meta = chart.getDatasetMeta(i);
                                meta.data.forEach((bar, index) => {
                                    const data = dataset.data[index];
                                    const faixa = chart.data.labels[index];
                                    const info = coresInfo[faixa];
                                    
                                    if (data > 0) {
                                        // Cor do texto baseada na cor da barra
                                        ctx.fillStyle = info.cor;
                                        ctx.strokeStyle = '#fff';
                                        ctx.lineWidth = 3;
                                        
                                        const text = `${data}`;
                                        const x = bar.x;
                                        const y = bar.y - 8;
                                        
                                        // Contorno branco para melhor legibilidade
                                        ctx.strokeText(text, x, y);
                                        ctx.fillText(text, x, y);
                                    }
                                });
                            });
                        }
                    },
                    hover: {
                        animationDuration: 300
                    },
                    layout: {
                        padding: {
                            top: 30, // Aumentar padding superior para acomodar os labels
                            bottom: 10,
                            left: 0,
                            right: 0
                        }
                    }
                }
            });
        }

    </script>
</body>

</html>